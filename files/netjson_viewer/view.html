<!doctype html>
<html>
<head>
  <title>Network | Basic usage</title>

  <!-- This file use the http://visjs.org API -->
  <script type="text/javascript" src="vis.js"></script>
  <link href="vis.css" rel="stylesheet" type="text/css" />

  <style type="text/css">
    #mynetwork {
      width: 1280px;
      height: 768px;
      border: 1px solid lightgray;
    }
  </style>
</head>
<body>

<p>
  Visualization of olsrd2 netjson graph
</p>

<div id="mynetwork"></div>

<script type="text/javascript">
var visNodes, visEdges, visData, visNetwork;
var count;

// this URL should return the netjson graph output
var netjsonurl = "http://169.254.0.101/cgi/netjson.cgi";

function init_network() {
  var options = {
//      queue: {
//          delay: Infinty,
//      },
  };
  
  // create an array with nodes
  visNodes = new vis.DataSet([], options);

  // create an array with edges
  visEdges = new vis.DataSet([], options);

  // create a network
  var container = document.getElementById('mynetwork');
  var visData = {
    nodes: visNodes,
    edges: visEdges
  };
  
  options = {};
  visNetwork = new vis.Network(container, visData, options);
  
  count = 0;
}

function layout_graph(element) {
    nodes = element.nodes;
    
    for (ni = 0; ni < nodes.length; ni++) {
        var nId = nodes[ni].id;
        var nLabel = nId;
        var nBorder = 1;
        
        if (nodes[ni].id == element.router_id) {
            nBorder = 5;
        }

        if (visNodes.get(nId)) {    
            visNodes.update(
                {
                    id:          nId,
                    label:       nLabel,
//                    physics:     false,
                }
            );
        }
        else {
            visNodes.update(
                {
                    id:          nId,
                    label:       nLabel,
                    borderWidth: nBorder,
                }
            );
        }
    }
    
    edges = element.links;

    for (ei = 0; ei < edges.length; ei++) {
        var eFrom = edges[ei].source;
        var eTo = edges[ei].target;
        var eUuid = eFrom + "-" + eTo;
        var eWidth = 1;
        var eLabel = edges[ei].weight.toString();
        
        if (edges[ei].properties) {
            if (edges[ei].properties["weight_txt"]) {
                eLabel = edges[ei].properties["weight_txt"];
            }
            if (edges[ei].properties["outgoing_tree"] == "true") {
                eWidth=3;
            }
        }
        
        if (visEdges.get(eUuid)) {
            visEdges.update(
                {
                    id:          eUuid,
                    label:       eLabel,
                    width:       eWidth,
//                    physics:     false,
                }
            );
        }
        else {
            visEdges.update(
                {
                    id:          eUuid,
                    from:        eFrom,
                    to:          eTo,
                    label:       eLabel,
                    arrows:      "to",
                    length:      200,
                    width:       eWidth,
                    font: {
                        align:       "top",
                    }
                }
            );
        }
    }
}

function xmlhttp_changed()
{
    if (xmlhttp.readyState==XMLHttpRequest.DONE && xmlhttp.status==200) {
        obj = JSON.parse(xmlhttp.responseText);

        if (obj.type != "NetworkCollection") {
            return;
        }

        for (index = 0; index < obj.collection.length; index++) {
            element = obj.collection[index];

            if (element.router_id.indexOf(':') != -1) {
                continue;
            }

            if (element.type == "NetworkGraph") {
                layout_graph(element);
            }
        }
        if (count < 3) {
            count = count + 1;
            window.setTimeout(send_request, 5000);
        }
    }
}

init_network();
var xmlhttp = new XMLHttpRequest();
xmlhttp.onreadystatechange=xmlhttp_changed

function send_request()
{
    xmlhttp.open("GET",netjsonurl,true);
    xmlhttp.send();
}

send_request();

</script>

</body>
</html>
